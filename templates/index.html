<!DOCTYPE html>
<html>
<head>
    <title>App Store Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>App Store Analytics</h1>
            <a href="/logs" class="view-logs">View Logs</a>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Enter app name...">
            <button onclick="searchApp()">Search</button>
            <button onclick="searchDeerwalk()" class="search-button deerwalk-button">
            <i class="fas fa-search"></i> Search Deerwalk
        </button>
        </div>
        <div id="result" class="result"></div>
    </div>
    <script>
        async function searchApp() {
            const appName = document.getElementById('searchInput').value.trim();
            if (!appName) return;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Searching...</p>';
            
            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ app_name: appName })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} ${response.statusText}\n${errorText}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    console.error('JSON parse error:', jsonError);
                    throw new Error('Invalid response from server. Please try again.');
                }
                
                if (data && data.error) {
                    throw new Error(data.error);
                }
                
                let html = `
                    <h2>${data.title}</h2>
                    <p><strong>Developer:</strong> ${data.developer}</p>
                    <p><strong>Installs:</strong> ${data.installs}</p>
                `;
                
                if (data.realInstalls) {
                    html += `<p><strong>Real Installs:</strong> ${data.realInstalls.toLocaleString()}</p>`;
                }
                
                html += `<p><strong>Score:</strong> ${data.score} (${data.ratings.toLocaleString()} ratings)</p>`;
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Search error:', error);
                let errorMessage = error.message || 'An unknown error occurred';
                // Handle HTML error responses
                if (errorMessage.startsWith('Server error:') && errorMessage.includes('<!DOCTYPE html>')) {
                    errorMessage = 'Server error: Please check the server logs for more details';
                }
                resultDiv.innerHTML = `<div class="error">
                    <p><strong>Error:</strong> ${errorMessage}</p>
                    <p>Please try again or check the logs for more information.</p>
                </div>`;
            }
        }
        
        // Function to search for Deerwalk Learning Center
        function searchDeerwalk() {
            document.getElementById('searchInput').value = 'Deerwalk';
            searchApp();
        }

        // Allow searching with Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchApp();
            }
        });
    </script>
</body>
</html>
